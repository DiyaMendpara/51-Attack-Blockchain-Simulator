apiVersion: apps/v1
kind: Deployment
metadata:
  name: blockchain-simulator
  labels:
    app: blockchain-simulator
spec:
  replicas: 3
  selector:
    matchLabels:
      app: blockchain-simulator
  template:
    metadata:
      labels:
        app: blockchain-simulator
    spec:
      containers:
      - name: flask-app
        image: blockchain-simulator:latest
        ports:
        - containerPort: 5000
        env:
        - name: FLASK_ENV
          value: "production"
        - name: ETH_RPC_URL
          value: "http://hardhat-node:8545"
        - name: CLOUD_STORAGE_PROVIDER
          valueFrom:
            configMapKeyRef:
              name: blockchain-config
              key: cloud-storage-provider
        - name: CLOUD_MONITORING_PROVIDER
          valueFrom:
            configMapKeyRef:
              name: blockchain-config
              key: cloud-monitoring-provider
        - name: AWS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              name: aws-credentials
              key: access-key-id
        - name: AWS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: aws-credentials
              key: secret-access-key
        - name: AZURE_STORAGE_CONNECTION_STRING
          valueFrom:
            secretKeyRef:
              name: azure-credentials
              key: connection-string
        - name: GCP_PROJECT_ID
          valueFrom:
            configMapKeyRef:
              name: blockchain-config
              key: gcp-project-id
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /
            port: 5000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /
            port: 5000
          initialDelaySeconds: 5
          periodSeconds: 5
      - name: hardhat-node
        image: blockchain-hardhat:latest
        ports:
        - containerPort: 8545
        - containerPort: 3001
        env:
        - name: INDEXER_RPC_URL
          value: "http://localhost:8545"
        - name: INDEXER_PORT
          value: "3001"
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "1Gi"
            cpu: "1000m"
        livenessProbe:
          httpGet:
            path: /
            port: 8545
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /
            port: 8545
          initialDelaySeconds: 10
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: blockchain-simulator-service
spec:
  selector:
    app: blockchain-simulator
  ports:
  - name: flask
    port: 5000
    targetPort: 5000
  - name: hardhat
    port: 8545
    targetPort: 8545
  - name: indexer
    port: 3001
    targetPort: 3001
  type: LoadBalancer
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: blockchain-config
data:
  cloud-storage-provider: "aws"
  cloud-monitoring-provider: "aws"
  gcp-project-id: "your-gcp-project-id"
  cloud-storage-bucket: "blockchain-simulator"
  cloud-monitoring-namespace: "BlockchainSimulator"
---
apiVersion: v1
kind: Secret
metadata:
  name: aws-credentials
type: Opaque
data:
  access-key-id: <base64-encoded-access-key>
  secret-access-key: <base64-encoded-secret-key>
---
apiVersion: v1
kind: Secret
metadata:
  name: azure-credentials
type: Opaque
data:
  connection-string: <base64-encoded-connection-string>
---
apiVersion: v1
kind: Secret
metadata:
  name: gcp-credentials
type: Opaque
data:
  service-account-key: <base64-encoded-service-account-key>
